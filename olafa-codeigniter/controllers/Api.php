<?php

 
class Api extends CI_Controller {

    /**
     * Constructor
     */
    function __construct() {
        parent::__construct(); 
		$this->load->model('ApiModel');  
		$this->load->model('RfidModel','rm', TRUE);  
		$this->load->model('ApiMobileModel', 'api', TRUE); 
		//$this->load->library('email');  
		$this->load->library("Encrypt");
		ini_set('MAX_EXECUTION_TIME', -1);
		ini_set('memory_limit','-1');
		
		
    } 
	
	// function tester(){
		// $data = array ('089606760054','089606764709','089607048059','089607182863','089607206788','089607288023','089607327461','089607334188','089607343615','089607489474','089607520269','089607580371','089607595461','089607634189','089607684205','089607708152','089607736485','089607813107','089607985812','089608087942','089608132092','089608137512','089608309609','089608354916','089608361110','089608452352','089608572069','089608579219','089608775220','089608878785','089609009392','089609029636','089609111307','089609157615','089609222409','089609356431','089609532108','089609717789','089609886806','089609955706','089610058432','089610060036','089610126427','089610155520','089610172228','089610226919','089610392458','089610556348','089610570388','089610632034','089610715975','089610840578','089611113034','089611158345','089611261319','089611352166','089611458362','089611494003','089611507412','089611539004','089611575235','089611666219','089611688711','089611739726','089611835117','089611911198','089612062369','089612089213','089612165345','089612363102','089612559892','089612887131','089613081165','089613196277','089613372512','089613401311','089613583841','089613635470','089613666481','089613730375','089613736307','089613777580','08961384927','089613932262','089613941242','089614044266','089614097978','089614205985','089614234812','089614293260','089614361958','089614374707','089614438555','089614560585','089614638887','089614727491','089614741563','089615018550','089615025632','089615050786','089615076348','089615125895','089615171805','089615253278','089615372346','089615530697','08961553350','089615730888','089615740097','089615815474','089616256807','089616468298','089616669930','089616892607','089616907420','089617028255','089617064255','089617128735','089617132475','089617159615','089617190493','089617209000','089617332317','089617452777','089617659848','089617776804','089618122492','089618225750','089618315125','089618401909','089618434639','089618473633','089618510073','089619111651','089619149073','089619227242','089619368149','089619469710','089619538910','089619554752','089619600622','089619652192','089619671289','089619828690','089620009610','089620017679','089620052052','089620080889','089620088928','089620189943','089620193956','089620250578','089620310291','089620385175','089620407973','089620431180','089620531401','089620631186','089620693780','089620716731','089620789021','089621062821','089621076551','089621112644','089621156702','089621181905','089621310952','089621421431','089621476522','089621559028','089621569548','089621824683','089622017836','089622104356','089622222429','089622292217','089622340266','089622512386','08962257705','089622598198','089622808572','089622903129','089623063439','089623064366','089623110756','089623132313','089623140863','089623154186','089623244213','089623510187','089623641270','089623719695','089623956397','089624008092','089624020193','089624298950','089624304304','089624400437','089624604788','089624671215','089624944398','089624979638','089624985897','089625124979','089625133516','089625150287','089625361579','089625378032','089625425551','089625471189','089625473411','089625568558','089625611480','089625625620','089625706898','089625787097','089625806053','089625864266','089626045293','089626183313','089626422493','089626431820','089626869219','089626879352','089626919621','089627042345','089627224426','089627266933','089627288549','089627351673','089627367909','089627426503','089627428678','089627451113','089627568550','089627645423','089627727086','089627811716','089627920133','089628039294','089628060091','089628110257','089628114429','089628181204','089628199259','089628272522','089628283552','089628301563','089628576935','089628577014','089628635037','089628776353','089628889334','089628959132','089629194703','089629278511','089629290697','089629363345','089629449618','089629607911','089629619715','089629619763','089629621334','089629714498','089629746424','089629919712','089629926150','089629992235','089630197390','089630257846','089630273727','089630306469','089630318243','089630320423','089630388152','089630393052','089630445887','089630563187','089630627145','089630705342','089630746968','089630810853','089630811094','089630907374','089630945835','089631007145','089631112749','089631115198','089631121895','089631292581','089631334861','089631404816','089631449096','089631508898','089631532582','089631572956','089631577527','089631626470','089631675295','089631720262','089631738195','089631968890','089632065913','089632163044','089632399039','089632602558','089632741003','089632900105','089632987099','089633000959','089633073508','089633079390','089633086552','089633136992','089633294508','089633300311','089633447707','089633473419','089633498381','089633716274','089633722868','089633809474','089633974097','089634117785','089634548611','089634576691','089634589334','089634613483','089634843548','089634873373','089634936764','089635036841','089635063646','089635220724','089635242360','089635339241','089635533686','089635556042','089635642739','089635757331','089635927547','089635971731','089636153830','089636194210','089636202288','089636250768','089636333618','089636350042','089636490236','089636591331','089636624662','089636666761','089636704753','089636820360','089636853083','089636922196','089636965985','089636978097','089636996642','089637048246','089637127522','089637156646','089637175087','089637220054','089637245815','089637270590','089637279119','089637336261','089637426364','089637507482','089637554733','089637569554','089637577760','089637591258','089637643908','089637730832','089637753457','089637755742','089637836486','089637974225','089637974532','089638002937','089638069647','089638162217','089638242355','089638344231','089638426088','089638554457','089638720261','089638726453','089638759404','089638901702','089638956111','089639024234','089639087085','089639114669','089639210554','089639272797','089639275017','089639282600','089639407904','089639416641','089639656362','089639739150','089639760414','089639783806','089639858144','089639942556','089639945939','089641550522','089641770955','089641786029','089642187417','089642679238','089643090814','089643365108','089643618699','089643693633','089643778492','089644212769','089644338265','089644580675','089644688845','089644803321','089644809076','089644969998','089646420989','089646525485','089646682101','089646709267','089646738735','089646818084','089646862599','089646871805','089646875123','089646958856','089646964687','089647047271','089647126228','089647484940','089647710566','089647740197','089647785949','089647946620','089648003152','089648050236','089648082836','089648190949','089648219144','089648314001','089648428190','089648552672','089648605999','089648634234','089648653888','089648657111','089648745048','089648952065','089649009269','089649073165','089649159752','089649241552','089649284397','089649289159','089649406575','089649541458','089649628558','089649724699','089649765076','089649799822','089649921054','089649999074','089650007061','089650039097','089650123372','089650153433','089650177812','089650204403','089650221240','089650247051','089650306261','089650381136','089650567754','089650716895','089650731119','089650824299','089650907627','089650948075','089651200625','089651375440','089651401019','089651415323','089651416099','089651471308','089651485224','089651686903','089651688027','089651698259','089651846722','089651871715');
		 
		// foreach($data as $row){
			// $this->SendSms($row,'Nikmati berita sesuai kebutuhanmu. Dapatkan akses Kompas.id GRATIS di jaringan wifi Telkom University. Daftar sekarang:  klik.kompas.id/tel-u');
		// }
	// }
	
	// function tester2(){
		// $data = array ('089651876534','089651937097','089652131419','089652295798','089652425832','089652459517','089652484686','089652508125','089652516979','089652537527','089652563962','089652627703','089652669231','089652674531','089652685366','089652688754','089652703833','089652744587','089652973805','089653206229','089653214326','089653250207','089653317937','089653332219','089653370917','089653382268','089653416594','089653529192','089654016248','089654029153','089654033797','089654088468','089654089628','089654105440','089654171509','089654215855','089654334980','089654588846','089654789193','089654844780','089654846401','089654926627','089654965350','089655007184','089655073488','089655086045','089655099668','089655123482','089655194136','089655198052','089655207701','089655215545','089655294910','089655382023','089655398331','089655440395','089655448940','089655459950','089655468431','089655493820','089655517336','089655551996','089655581045','089655620094','089655704793','089655727845','089655731227','089655773799','089655777536','089655914390','089655969605','089655974282','089656040256','089656051666','089656064941','089656106874','089656132398','089656142747','089656162977','089656213618','089656216458','089656223038','089656225666','089656226556','089656263025','089656279248','089656317117','089656326745','089656334211','089656364558','089656397524','089656401117','089656410898','089656428158','089656430057','089656508503','089656561886','089656596511','089656611214','089656642223','089656813894','089656843585','089656866887','089656868362','089656932318','089657013196','089657025375','089657114701','089657117028','089657178058','089657191104','089657238313','089657240084','089657314650','089657376736','089657403645','089657426022','089657469464','089657487042','089657495748','089657519162','089657535889','089657544577','089657552495','089657638185','089657713429','089657755096','089657837847','089657850644','089657899649','089657960872','089657962833','089657968114','089657976733','089657986387','089658010212','089658272992','089658477091','089658522794','089658528955','089658552931','089658695393','089658730587','089658743367','089658757714','089658991840','089659024050','089659106862','089659120480','089659131328','089659147219','089659417140','089659456247','089659874403','089659933435','089660075884','089660213291','089660219727','089660232039','089660291977','089660299234','089660342209','089660389325','089660443545','089660497260','089660500404','089660501313','089660537777','089660605083','089660606290','089660613309','089660618004','089660668566','089660745061','089660751650','089660767247','089660796233','089660814182','089660835371','089661045371','089661095488','089661108834','089661112545','089661265661','089661278722','089661329482','089661396903','089661409406','089661413966','089661545151','089661672974','089661764223','089661813025','089661833886','089661879209','089661879209','089662060294','089662224770','089662254709','089662293956','089662330036','089662342714','089662373921','089662382640','089662436053','089662458534','089662513210','089662552214','089662553528','089662570101','089662625097','089662691000','089662708069','089662748775','089662814788','089662815639','089662847204','089662865428','089662926025','089662929448','089662929768','089663114048','089663116772','089663160292','089663331229','089663409215','089663494274','089663604647','089663782561','089663866962','089663887864','089663935352','089664063493','089664088222','089664332477','089664332789','089664360497','089664388860','089664461107','089664516433','089664517447','089664526215','089664602016','089664609272','089664777201','089665088846','089665155736','089665264036','089665276307','089665277511','089665318584','089665332448','089665352179','089665456184','089665507227','089665512559','089665571530','089665626211','089665636919','089665648164','089665666636','089665676906','089665771378','089665846665','089666043996','089666063132','089666098425','089666112243','089666235081','089666516979','089666548638','089666727315','089666732208','089666826793','089666843357','089666903750','089666927076','089666960450','089666999098','089667056546','089667282361','089667300149','089667325252','089667433039','089667549390','089667711006','089667824502','089667899021','089668305687','089668307443','089668316958','089668386365','089668689487','089668710509','089668719532','089668740449','089668907089','089668911702','089668967987','089668977742','089668984804','089669301693','089669309419','089669409202','089669417332','089669725257','089669842844','089669862866','089669869009','089669872688','089669914620','089669973615','089670027101','089670082881','089670101944','089670120944','089670131745','089670241893','089670530801','089670634399','089670711202','089670743894','089670846382','089670862406','089670919451','089670997080','089671008646','089671025753','089671126991','089671211173','089671224541','089671258817','089671333342','089671359854','089671533957','089671813927','089671820986','089671842141','089671850612','089671879779','089671879779','089672039894','089672151011','089672164470','089672232742','089672443810','089672599644','089672660840','089672661792','089672689356','089672758977','089672952119','089672985682','089673180069','089673241130','089673294440','089673415176','089673424631','089673561533','089673570075','089673636240','089673671326','089673784555','089673909303','089674055528','089674068346','089674073736','089674158614','089674242843','089674597434','089674608022','089674903698','089675200600','089675205995','089675262255','089675303695','089675317156','089675502363','089675595278','089675670419','089675688630','089675851980','089675902403','089675969158','089676072758','089676227583','089676227770','089676315851','089676572426','089676637034','089676700740','089676815410','089676824961','089676825007','089676853850','089677079175','089677323201','089677419014','089677494095','089677600488','089677614208','089677869631','089677888051','089677892227','089677953522','089677987131','089678000631','089678044604','089678225430','089678264680','089678302931','089678487677','089678520615','089678543322','089678656113','089678728590','089678822261','089678822677','089678824489','089678832813','089678859852','089678999303','089679025746','089679029494','089679109160','089679136620','089679195820','089679213164','089679237005','089679241494','089679247588','089679266779','089679405522','089679478197','089679482422','089679587013','089679728421','089679767190','089679781238','089680135744','089680271179','089680432202','089680799414','089680841811','089681034626','089681214735','089681226260','089681236846','089681259841','089681262629','089681323127','089681324777','089681383296','089681485898','089681520848','089681724413','089681755325','089681796320','089681850547','089681908268','089681964715','089682011566','089682112696','089682182789','089682276795','089682384054','089682387950','089682605662','089682702203','089682761302','089682805930','089682826630','089682830145','089682896301','089683068923','089683110332','089683121930','089683170269','089683173940','089683212517','089683298599','089683313878','089683354920','089683363308','089683553358','089683612212','089683642874','089683939725','089684904093','089685020571','089685210574','089685243156','089685247265','089685359304','089685368132','089685411888','089685609762','089685639043','089685653691','089685765560');
		 
		// foreach($data as $row){
			// $this->SendSms($row,'Nikmati berita sesuai kebutuhanmu. Dapatkan akses Kompas.id GRATIS di jaringan wifi Telkom University. Daftar sekarang:  klik.kompas.id/tel-u');
		// }
	// } 
	
	// function tester3(){
		// $data = array ('089685817242','089685858500','089685866724','089685923484','089685948385','089686060956','089686097461','089686113294','089686423337','089686423769','089686557176','089686599521','089686691609','089686717909','089686822021','089686879249','089687055989','089687105641','089687158845','089687172408','089687187243','089687241065','089687263597','089687363468','089687479968','089687665075','089687688421','089687833814','089687842756','089687857977','089687865491','089687960072','089687992262','089688017570','089688030943','089688055033','089688276782','089688346196','089688400244','089688429055','089688537398','089688777954','089688862699','089688890999','089688891027','089688903968','089688912351','089689042542','089689116607','089689203225','089689773910','089689809739','089689870711','089689904515','089690409250','089690418484','089690462820','089690908519','089691006925','089691163345','089691179003','089691544232','089691578752','089691691271','089691858681','089691971707','089692008218','089692053992','089692135138','089692141898','089692170543','089692204092','089692366305','089692534989','089692569111','089692579225','089692818573','089692837734','089692846934','089693045003','089693087966','089693239459','089693395494','089693413730','089693512013','089693531090','089693627298','089693636794','08969366837','089693693818','089693813174','089693831995','089693932547','089694210613','089694214380','089694294614','089694297420','089694339362','089694423754','089694520279','089694585437','089694697596','089694847330','089694934964','089694936776','089694938937','089694984776','089694987241','089694988604','089694991367','089695006315','089695118640','089695246689','089695318560','089695334347','089695524150','089695528657','089695587725','089695681233','089695750613','089695980618','089696106656','089696324890','089696363987','089696363987','089696378052','089696395083','089696411464','089696587314','089696627887','089696761205','089696969147','089697339067','089697532844','089697690447','089697696957','089697717940','089697789327','089697845958','089697900155','089698029288','089698147605','089698200508','089698225764','089698271959','089698290291','089698351516','089698370827','089698387560','089698541246','089698706032','089698825922','089698914166','089698944432','089698973081','089698975897','089699062220','089699076774','089699103981','089699226533','089699255703','089699275174','089699452270','089699541024','089699593662','089699645889','089699777285','089699855772','089699929442','089699940025','089699972224','08970077473','08970110263','08970150966','08970157609','08970182772','08970279022','08970395471','08970403525','08970407967','08970443974','08970484092','08970690287','08970743113','08970772296','08970789370','08970825256','08970847589','08970867525','08970899383','08970911963','08970959129','08971162536','08971301167','08971632388','08971646507','08971716366','08971733964','08971770231','08971808766','08972037086','08972075527','08972113360','08972158208','08972183875','08972233059','08972239991','08972266014','08972276879','08972279552','08972329123','08972365195','08972373793','08972426508','08972450966','08972452778','08972470363','08972470960','08972554123','08972555781','08972597259','08972646194','08972668176','08972817714','08972962802','08972987708','08973077103','08973234642','08973243825','08973288477','08973350816','08973471969','08973597423','08973632055','08973913078','08973926491','08973947656','08974062189','08974132267','08974227782','08974310099','08974341853','08974374629','08974500823','08974569188','08974648922','08974663755','08975018789','08975329631','08975333191','08975425303','08975441083','08975490031','08975606441','08975654230','08975727690','08975732399','08975752885','08975794285','08975856724','08975899181','08975923586','08975961590','08976047566','08976237574','08976245775','08976283392','08976325523','08976348982','08976369088','08976386584','08976448316','08976488373','08976666144','08976732358','08977009775','08977018985','08977057827','08977180186','08977323799','08977514372','08977522079','08977553209','08977567902','08977574857','08977591868','08977614480','08977660272','08977660617','08977693620','08977774528','08977816669','08977955117','08978011931','08978063699','08978105882','08978163423','08978210731','08978295998','08978312010','08978325173','08978341402','08978351610','08978367037','08978401110','08978417879','08978422880','08978439562','08978509201','08978725279','08978789298','08978821973','08978928699','08978988808','08979049424','08979050458','08979239610','08979341492','08979389068','08979631928','08979638077','08979656973','08979721458','08979727897','08979730136','08979788787','08979842476','08979874174','08979896353','08979924081','08979973785','08979997240','08980000321','08980007723','08980033829','08980037334','08980038557','08980040382','08980043358','08980045898','08980050076','08980077313','08980089725','08980148848','08980206035','08980515878','08980564172','08980594086','089808192632','08980820027','08980906673','08980960257','08981114088','08981265219','08981301809','08981536534','08981630237','08981639088','08981720925','089820095125','08982180019','08982206705','08982292287','08982314744','08982355127','08982392938','08982419293','08982517051','08982544417','08982705886','08982761642','08982863181','08983166258','08983211271','08983219557','08983230423','08983627573','08983786068','08983957946','08983991288','08984023500','08984038709','08984051233','08984051320','08984124646','08984124684','08984309434','08984478107','08984527337','08984637980','08984708380','08984784548','08984784548','08984868050','08984877628','08984944468','08984948404','08984991619','08985013224','08985134407','08985156492','08985251564','08985290726','08985373365','08985416584','08985423689','08985547886','08985668749','08985712594','08985762830','08985792165','08985825521','08985845566','08985876881','08985966157','08985972877','08986117942','08986126761','08986164284','08986167288','08986241417','08986263535','08986409951','08986440908','08986514761','08986519526','08986537350','08986558489','08986600655','08986625121','08986641720','08986681820','08986725225','08986776338','08986794228','08986800165','08986806013','08986825435','08986844317','08986888162','08986921722','08986934208','08987017838','08987151616','08987151677','08987424777','08987482382','089876059666','08987609077','08987678854','08987738328','08987747157','08987788670','08987794311','08987873571','08987878488','08987920968','08987930597','08987993467','08988120130','08988487439','08988534558','08988605965','08988701585','08988720700','08988721897','08988827773','08988829805','08988858534','08988882231','08988894809','08988919421','08988973350','08988986037','08989080963','08989107634','08989154850','08989205959','08989219825','08989225959','08989226313','08989319251','08989414998','08989426526','08989432384','08989631780','08989680100','08989793804','08989934158','08989936929','08990020144','08990020335','08990075668','08990144991','08990281491','08990333752','08990414292','08990424585','08990493409','08990500940');
		 
		// foreach($data as $row){
			// $this->SendSms($row,'Nikmati berita sesuai kebutuhanmu. Dapatkan akses Kompas.id GRATIS di jaringan wifi Telkom University. Daftar sekarang:  klik.kompas.id/tel-u');
		// }
	// } 
	
	function SendSms($destinationNumber, $sms_message, $queue = false, $providerid = false, $inputby = false) {
 
		if ($queue) {
			$queue = 'true';
		} else {
			$queue = 'false';
		}

		//set POST variables
		$url = 'http://api.telkomuniversity.ac.id/sms/send';
		$fields = array(
			'msisdn' => urlencode($destinationNumber),
			'message' => urlencode($sms_message),
			'appname' => urlencode('openlibrary'),
			'operatorid' => urlencode($providerid),
			'inputby' => urlencode('openlibrary'),
			'queue' => urlencode($queue) //must be set on string true,false
		);
		//for basic auth
		$username = 'openlibrary';
		$password = 'Bloodseek3r'; 
		
		$result = $this->httpPostBasicAuth($url, $fields, $username, $password);
		return $result;
	}
	
	function httpPostBasicAuth($url, $fields, $username, $password) {
		$fields_string = "";
		//url-ify the data for the POST
		foreach ($fields as $key => $value) {
			$fields_string .= $key . '=' . $value . '&';
		}
		$fields_string = rtrim($fields_string, '&');

		//open connection
		$ch = curl_init();

		//set the url, number of POST vars, POST data
		curl_setopt($ch, CURLOPT_URL, $url);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_HEADER, false);
		curl_setopt($ch, CURLOPT_USERPWD, $username . ":" . $password); //BASIC AUTH
		curl_setopt($ch, CURLOPT_POST, count($fields));
		curl_setopt($ch, CURLOPT_POSTFIELDS, $fields_string); //HTTP POST
		//execute post
		$result = curl_exec($ch);

		//close connection
		curl_close($ch);

		return $result;
	}
	
	function native_curl()
	{
		$username = 'openlibrary';
		$password = 'Indonesia1945';
		 
		// Alternative JSON version
		// $url = 'http://twitter.com/statuses/update.json';
		// Set up and execute the curl process
		$curl_handle = curl_init();
		curl_setopt($curl_handle, CURLOPT_URL, 'http://openlibrary.telkomuniversity.ac.id/olafa/index.php/rfid');
		curl_setopt($curl_handle, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($curl_handle, CURLOPT_POST, 1);
		curl_setopt($curl_handle, CURLOPT_POSTFIELDS, array(
			'rfid' => '33A5F9D4'
		));
		 
		// Optional, delete this line if your API is open
		curl_setopt($curl_handle, CURLOPT_USERPWD, $username . ':' . $password);
		 
		$buffer = curl_exec($curl_handle);
		curl_close($curl_handle);
		 
		$result = json_decode($buffer);
	 
		if(isset($result->status) && $result->status == 'success')
		{
			echo 'User has been updated.';
		}
		 
		else
		{
			echo 'Something has gone wrong';
		}
	}
	
	function copy_htaccess() {
		$file = $_SERVER["DOCUMENT_ROOT"]."/../../flippingbook/";
		//echo $file;
		$data = scandir($file);
		foreach ($data as $key=> $dt){
			if ($dt!='.' and $dt!='..' and is_dir($file.$dt)){
				if (copy($file.'09201.638/.htaccess',$file.$dt.'/.htaccess'))
					echo $file.$dt;
			}
			// if ($key>5)
			// break;
		}
	}
	
	// function scheduler() { 
		// $time = $this->ApiModel->schedulerLog()->num_rows();
		// if ($time<1){
			
			// //update file total
			// $listFile=array();
			// $hitFile =array();
			// $upload	 = $this->ApiModel->getUploadType(); 
			// foreach($upload as $up){
				// if($up->extension=='pdf'){
					// $listFile[] = $up->name.'.'.$up->extension;
					// $ids[] = $up->id;
					// $secure[] = $up->is_secure;
					// $hitFile[]  = 0;
				// }
			// }
		
			// $dir    = '../../../data/batik/symfony_projects/book';
			// $files1 = scandir($dir);

			// foreach ($files1 as $row){
				// if ($row!='.' && $row!='..'){ 
					// for ($i=0;$i<count($listFile);$i++){
						// $file    = '../../../data/batik/symfony_projects/book/'.$row.'/'.$row.'_'.$listFile[$i];
						// if (file_exists($file)) $hitFile[$i]++;
					// } 
				// }
			// } 
			
			// $this->ApiModel->DeleteFileTotal(); 
			// for ($i=0;$i<count($listFile);$i++){
				// $data = array ('nama_file' => $listFile[$i], 'total_file' => $hitFile[$i], 'file_id' => $ids[$i], 'keterangan' => $secure[$i]);
				// $this->ApiModel->InsertFileTotal($data);
			// } 
			// //===============================================================================
			
			
			// $this->ApiModel->removePhoneMasterData();
			
			// $member = $this->ApiModel->getMember()->result();
			// foreach($member as $row){
				// $data = array ('member_id' => $row->id,'member_phone_number'=>"");
				// $this->ApiModel->InsertMemberPhone($data);
			// }	

			// $phone = $this->ApiModel->getMemberPhone()->result();
			
			// $dts 	= array();
			// $users 	= $this->ApiModel->getIgracias()->result();
			// foreach($users as $key => $row){
				// $dts[$row->c_username] = $row->hp;
			// }
			
			// foreach($phone as $key => $row){
				// if(ISSET($dts[$row->master_data_user])){
					// if ($dts[$row->master_data_user]!=$row->member_phone_number && $dts[$row->master_data_user]!=null && $dts[$row->master_data_user]!=""){
						// $data = array ('member_phone_number' => $dts[$row->master_data_user]);
						// $this->ApiModel->UpdateMemberPhone($data,$row->id);
					// }
				// } 
			// }					
			
			// $data = array ('sch_log_date' => date('Y-m-d'));
			// $this->ApiModel->InsertSchedulerLog($data);
			// echo "success   ";
		// } 
    // } 

	// function sendMail($email,$encode,$password)
	// {
		// $data['email'] 		= $email;
		// $data['password'] 	= $password;
		// $data['encode']	    = $encode; 
		 
		// $this->load->helper('PHPMailer/PHPMailerAutoload');  
				 
		// /**
		 // * This example shows settings to use when sending via Google's Gmail servers.
		 // */

		// //SMTP needs accurate times, and the PHP time zone MUST be set
		// //This should be done in your php.ini, but this is how to do it if you don't have access to that
		// //date_default_timezone_set('Etc/UTC');

		// //Create a new PHPMailer instance
		// $mail = new PHPMailer;

		// //Tell PHPMailer to use SMTP
		// $mail->isSMTP();

		// //Enable SMTP debugging
		// // 0 = off (for production use)
		// // 1 = client messages
		// // 2 = client and server messages
		// $mail->SMTPDebug = 2;

		// //Ask for HTML-friendly debug output
		// $mail->Debugoutput = 'html';

		// //Set the hostname of the mail server
		// //$mail->Host = 'smtp.telkomuniversity.ac.id';
		// $mail->Host = 'smtp.gmail.com';
		// // use
		// // $mail->Host = gethostbyname('smtp.gmail.com');
		// // if your network does not support SMTP over IPv6

		// //Set the SMTP port number - 587 for authenticated TLS, a.k.a. RFC4409 SMTP submission
		// $mail->Port = 587;

		// //Set the encryption system to use - ssl (deprecated) or tls
		// $mail->SMTPSecure = 'tls';

		// //Whether to use SMTP authentication
		// $mail->SMTPAuth = true;

		// //Username to use for SMTP authentication - use full email address for gmail
		// $mail->Username = "yudhinugrohoadi@gmail.com";

		// //Password to use for SMTP authentication
		// $mail->Password = "b7u8n6d0a";

		// //Set who the message is to be sent from
		// $mail->setFrom('yudhinugrohoadi@gmail.com', 'Telkom University Open Library');
		 

		// //Set who the message is to be sent to
		// $mail->addAddress($email);

		// //Set the subject line
		// $mail->Subject = 'Telkom University Open Library Verification Account';

		// //Read an HTML message body from an external file, convert referenced images to embedded,
		// //convert HTML into a basic plain-text alternative body
		// $mail->msgHTML($this->load->view('email_template', $data, true));

		// //Replace the plain text body with one created manually
		// $mail->AltBody = 'This is a plain-text message body';

		// //Attach an image file

		// //send the message, check for errors
		// if (!$mail->send()) {
			// return "false";
		// } else {
			// return "true";
		// }
	// }		
	
	function verify($decode) { 
		$decode = $this->url_query_decode($decode);
		$user	= $this->encrypt->mcrypt_decode($decode,"Telkom University Open Library"); 
		
		
		$data = $this->ApiModel->checkVerify($user)->row();
		if ($data) {
			if ($this->ApiModel->edit("t_mst_user_login",'c_username',$user,array('STATUS_USER' => '1')) and $this->ApiModel->editMember("member",'master_data_user',$user,array('status' => '1')))
			echo header('Refresh: 4; URL=https://openlibrary.telkomuniversity.ac.id').'<span style="font-family: sans-serif;color:green;font-weight:bold;">Your account has been activated, you can now login.</span> <br><span style="font-family: sans-serif;">Redirecting to Homepage...</span>';
		}else{
			echo header('Refresh: 4; URL=https://openlibrary.telkomuniversity.ac.id').'<span style="font-family: sans-serif;color:red;font-weight:bold;">The url is either invalid or you already have activated your account.</span><br><span style="font-family: sans-serif;">Redirecting to Homepage...</span>';
		}
	} 
	
	function url_query_encode($array = array())
	{
		return str_replace('/', '_', rtrim(base64_encode(gzcompress(serialize($array))), '='));
	}


	function url_query_decode($str = '')
	{
		return (is_string($str) && strlen($str)) ? @unserialize(gzuncompress(base64_decode(str_replace('_', '/', $str)))) : FALSE;
	}
	
	function blacklistMail($user){
		
		$blacklistMail[] = '@gmail.';
		$blacklistMail[] = '@yahoo.';
		$blacklistMail[] = '@hotmail.';
		$blacklistMail[] = '@rocketmail.';
		$blacklistMail[] = '@kompas.';
		$blacklistMail[] = '@facebook.';
		$blacklistMail[] = '@tandex.';
		$blacklistMail[] = '@fastmail.';
		$blacklistMail[] = '@ymail.';
	
		
		 $status = "true";
		foreach ($blacklistMail as $row){
			if (strpos($user,$row)!==false) {
				$status = "false";
			}
		} 
		
		return $status;
	}
	
	function checkUsername() { 
		$user = strtolower($_POST['inp']['C_NIP']);
		$data = $this->ApiModel->checkUsername($user)->row(); 
		$status = $this->blacklistMail($user);
		
		if ($data) echo "false";
		else if ($status=="false") echo "false";
			else echo "true";
		
	}  
	
	
	
	function tes() { 
		$string 	  							= $this->encrypt->mcrypt_encode('sonya14ti@mahasiswa.pcr.ac.id',"Telkom University Open Library");
		$encode 	  							= $this->url_query_encode($string);
		echo $encode;
	}  
	
	function broadcast() {  
		ini_set('MAX_EXECUTION_TIME', -1);
		ini_set('memory_limit','-1');
		//$files = 'http://openlibrary.telkomuniversity.ac.id/olafa/download/poster.png';
		//echo '<img src="'.base_url().'download/poster.png">';
		$data = $this->ApiModel->getEmailBroadcast()->result(); 
		// foreach($data as $row){
			// $datas['pin'] 	= $row->email_code; 
			$datas['pin'] 	= 'aaa';
			$content 		= $this->load->view('request_pin_template', $datas,true);
			$state = SendEmail('yudhinugrohoadi@gmail.com','[eTicket Code] #TelULiteEvent2018 Literacy Gigs - DENGARKAN DIA',$content,'Telkom University Open Library','yudhi','download/poster.png');
			$dt = array('email_status'=>'sudah');
			// $this->ApiModel->UpdateBroadcast($dt,$row->email_code);
		// } 
		
	}   
	
	function register() {  
	
 		if (!$this->input->is_ajax_request()) exit('No direct script access allowed');
		$user 		= strtolower($_POST['inp']['C_NIP']);
		$data 		= $this->ApiModel->checkUsername($user)->row(); 
		$status 	= $this->blacklistMail($user);
		
		if (!($data)) {
			if ($status!="false"){
				$item 									= $_POST['inp'];
				$item['EMAIL'] 							= $item['C_NIP'];
				$item['C_KODE_STATUS_PEGAWAI'] 			= 'P';
				$item['C_KODE_STATUS_AKTIF_PEGAWAI'] 	= 'A';
				$item['F_AKTIF'] 						= '1';
				$item['C_DATE']							= date('Y-m-d H:i:s');
				$string 	  							= $this->encrypt->mcrypt_encode($item['EMAIL'],"Telkom University Open Library");
				$encode 	  							= $this->url_query_encode($string);
				if ($this->ApiModel->add('t_mst_pegawai',$item)) {
					$item2['C_USERNAME'] 		= $item['C_NIP'];
					$item2['PASSWORD'] 			= md5($_POST['password']);
					$item2['PASSWORD_X'] 		= $_POST['password'];
					$item2['C_KODE_JENIS_USER'] = 'pegawai';
					$item2['USR_SHARING'] 		= '1';
					$item2['USR_THEME'] 		= '1';
					$item2['USR_EXPIRED'] 		= '2025-01-01 00:00:00';
					$item2['USR_MDD'] 			= 'simak';
					//$item2['STATUS_USER'] 		= '1';
					$item2['STATUS_USER'] 		= '0';
					$item2['F_AKTIF'] 			= '1';
					$item2['C_DATE']			= date('Y-m-d H:i:s');
					
					$item3['USR'] 			= $item['C_NIP'];
					$item3['USR_FLG'] 		= '1';
					$item3['USR_SHR'] 		= '1';
					$item3['USR_UXP'] 		= '2025-01-01 00:00:00';
					$item3['USR_MDD'] 		= 'simak';
					$item3['USR_NAME'] 		= ucwords(strtolower($item['NAMA_PEGAWAI']));
					$item3['USR_PASS'] 		= md5($_POST['password']);
					$item3['THE'] 			= '1';
					$item3['USR_C_DATE']	= date('Y-m-d H:i:s');
					
					
					
					$item4['member_type_id'] 			= '19';
					$item4['member_class_id'] 			= '2';
					$item4['master_data_user'] 			= $item['C_NIP'];
					$item4['master_data_password'] 		= md5($_POST['password']);
					$item4['master_data_email'] 		= $item['C_NIP'];
					$item4['master_data_mobile_phone'] 	= $item['NO_HP'];
					$item4['master_data_fullname'] 		= ucwords(strtolower($item['NAMA_PEGAWAI']));
					$item4['created_at'] 				= date('Y-m-d H:i:s');
					$item4['status'] 					= '2';
					//$item4['status'] 					= '1';
					
					if ($this->ApiModel->add('t_mst_user_login',$item2) and $this->ApiModel->add('vfs_users',$item3) and $this->ApiModel->addMember('member',$item4)) {
						$datas['email'] 		= $item['EMAIL'];
						$datas['password'] 		= $item2['PASSWORD_X'];
						$datas['encode']	    = $encode; 
						$content 				= $this->load->view('email_template', $datas, true);
						$state = SendEmail($item['EMAIL'],'Activation Telkom University Open Library',$content,'Telkom University Open Library',ucwords(strtolower($item['NAMA_PEGAWAI'])));

						$state = json_decode($status);
						if($state['status']=='SUCCESS') $status = true;
					}
				}
			}
			else $status= "false";
		}
		else $status= "exist";
		
		echo $status;
    }
	
	function aaa(){
		SendEmail('yudhinugrohoadi@gmail.com','Activation Telkom University Open Library','test','Telkom University Open Library','test');
	}
	
	function sendMail($email="",$encode="",$password="")
	{
		$data['email'] 		= $email;
		$data['password'] 	= $password;
		$data['encode']	    = $encode; 
		 
		$this->load->helper('PHPMailer/PHPMailerAutoload');  
				 
		/**
		 * This example shows settings to use when sending via Google's Gmail servers.
		 */

		//SMTP needs accurate times, and the PHP time zone MUST be set
		//This should be done in your php.ini, but this is how to do it if you don't have access to that
		//date_default_timezone_set('Etc/UTC');

		//Create a new PHPMailer instance
		$mail = new PHPMailer;

		//Tell PHPMailer to use SMTP
		$mail->isSMTP();

		//Enable SMTP debugging
		// 0 = off (for production use)
		// 1 = client messages
		// 2 = client and server messages
		$mail->SMTPDebug = 2;

		//Ask for HTML-friendly debug output
		$mail->Debugoutput = 'html'; 
		//Set the hostname of the mail server
		//$mail->Host = 'smtp.telkomuniversity.ac.id';
		$mail->Host 		= 'smtp.gmail.com'; 
		$mail->Port 		= 587; 
		$mail->SMTPSecure	= 'tls'; 
		$mail->SMTPAuth 	= true; 
		$mail->Username 	= "yudhinugrohoadi@gmail.com"; 
		$mail->Password 	= "secret"; 
		$mail->setFrom('yudhinugrohoadi@gmail.com', 'Telkom University Open Library'); 
		$mail->addReplyTo('yudhi_n_adi@yahoo.co.id', 'Openlib');
		$mail->addAddress("yudhi_n_adi@yahoo.co.id"); 
		$mail->Subject 		= 'Telkom University Open Library Verification Account'; 
		$mail->msgHTML($this->load->view('email_template', $data, true));

		//Replace the plain text body with one created manually
		$mail->AltBody = 'This is a plain-text message body';

		//Attach an image file
 
		//send the message, check for errors
		if (!$mail->send()) {
			return "false";
		} else {
			return "true";
		}
	}
	
	function journal_visitor() {  
		if(!$this->input->is_ajax_request()) return false;
		$inp['jv_name'] = $_POST['name'];
		$inp['jv_date'] = date("Y-m-d H:i:s");
		
		if ($this->ApiModel->addMember('journal_visitor',$inp)) echo "true";
		else echo "false";
		
	}  

	//gate qr code     
	
	
	function ticket($temp) { 
		if($temp!='check') return false;
 
		$token =  $_GET['ticket'];
		$location =  $_GET['gate'];
		if($location=='1') $location = '9';
		// $itemnotif['notif_id_member'] 	= $token;
		// $itemnotif['notif_type'] 	= 'visitor';
		// $itemnotif['notif_content'] 	= $rfid;
		// $itemnotif['notif_date'] 	= date('Y-m-d H:i:s', strtotime('+7 hour'));
		// $itemnotif['notif_status'] 	= 'unread';
		// $itemnotif['notif_id_detail'] 	= 'aaaa';

		// $this->api->add_custom($itemnotif,'notification_mobile');
		// echo json_encode(array('status' => 'open'));

		if(strlen($token)<=15){ 
			echo json_encode(array('status' => 'closed'));
			//pake rfid
			// $case 	= $this->rm->GetRfidNotSameWithIgracias()->result(); 
			// // $rfid = dechex($token); 
		
			// $rfid = dechex($token);
			// // echo $rfid."<br>";
			// $temp1 = substr($rfid,6,2);
			// $temp2 = substr($rfid,4,2);
			// $temp3 = substr($rfid,2,2);
			// $temp4 = substr($rfid,0,2);
			// $rfid = strtoupper($temp1.$temp2.$temp3.$temp4);
			
			// // echo $rfid;

			// // print_r($case);

			// foreach($case as $ca){
			// 	$case_member[$ca->rfid] = $ca->username;
			// }

			// $dt = $this->rm->GetRfidScanner($rfid)->row();  
			// if ($dt){   
			// 	$temp = array(
			// 		"member_id" => $dt->id,
			// 		"master_data_course" => $dt->master_data_course,
			// 		"item_location_id" => '9',
			// 		"attended_at" => date('Y-m-d H:i:s'),
			// 		"created_at" => date('Y-m-d H:i:s'),
			// 		"created_by" => "checkin", 
			// 		"updated_by" => "checkin",
			// 		"updated_at" => date('Y-m-d H:i:s')
			// 	);  
			// 	$this->rm->addAttendance($temp); 

			// 	$item_location = $this->api->item_location(9)->row();

			// 	$messages 		= "Selamat Datang di Openlibrary ".$item_location->name;

			// 	$itemnotif['notif_id_member'] 	= $dt->master_data_user;
			// 	$itemnotif['notif_type'] 	= 'visitor';
			// 	$itemnotif['notif_content'] 	= $messages;
			// 	$itemnotif['notif_date'] 	= date('Y-m-d H:i:s', strtotime('+7 hour'));
			// 	$itemnotif['notif_status'] 	= 'unread';
			// 	$itemnotif['notif_id_detail'] 	= $id;

			// 	$this->api->add_custom($itemnotif,'notification_mobile');

			// 	echo json_encode(array('status' => 'open')); 
			// } 
			// else {
			// 	if (array_key_exists($rfid, $case_member)){
			// 		$member = $this->rm->GetMemberScanner($case_member[$rfid])->row(); 
			// 		if ($member){   
			// 			$temp = array(
			// 				"member_id" => $member->id,
			// 				"master_data_course" => $member->master_data_course,
			// 				"item_location_id" => '9',
			// 				"attended_at" => date('Y-m-d H:i:s'),
			// 				"created_at" => date('Y-m-d H:i:s'),
			// 				"created_by" => "checkin", 
			// 				"updated_by" => "checkin",
			// 				"updated_at" => date('Y-m-d H:i:s')
			// 			);
			// 			$this->rm->addAttendance($temp);  

			// 			$item_location = $this->api->item_location(9)->row();

			// 			$messages 		= "Selamat Datang di Openlibrary ".$item_location->name;

			// 			$itemnotif['notif_id_member'] 	= $dt->master_data_user;
			// 			$itemnotif['notif_type'] 	= 'visitor';
			// 			$itemnotif['notif_content'] 	= $messages;
			// 			$itemnotif['notif_date'] 	= date('Y-m-d H:i:s', strtotime('+7 hour'));
			// 			$itemnotif['notif_status'] 	= 'unread';
			// 			$itemnotif['notif_id_detail'] 	= $id;

			// 			$this->api->add_custom($itemnotif,'notification_mobile');

			// 			echo json_encode(array('status' => 'open')); 
						
			// 		} else echo json_encode(array('status' => 'closed'));
			// 	}
			// 	else echo json_encode(array('status' => 'closed'));
			// } 
		}
		else {    
			$this->load->helper('jwt'); 
	

			$jwt = new JWT();

			$payload = $jwt->decode($token, 'qrcode'); 
		
			$date = date('Y-m-d H:i:s');
			$timenow = strtotime($date);
			$timetoken = strtotime($payload->expired);
	  
			// //pake qrcode
			// if($timenow>$timetoken)  { 
			// 	echo json_encode(array('status' => 'closed'));
			// }
			// else {
				// $status 			= "success";
				$dt = $this->rm->GetRfid('',$payload->username)->row();  
				if ($dt){   
					$temp = array(
						"member_id" => $dt->id,
						"master_data_course" => $dt->master_data_course,
						"item_location_id" => $location,
						"attended_at" => date('Y-m-d H:i:s'),
						"created_at" => date('Y-m-d H:i:s'),
						"created_by" => "qrcode", 
						"updated_by" => "qrcode",
						"updated_at" => date('Y-m-d H:i:s')
					);  
					$this->rm->addAttendance($temp);
	

					$item_location = $this->api->item_location($location)->row();

					$messages 		= "Selamat Datang di Openlibrary ".$item_location->name;

					$itemnotif['notif_id_member'] 	= $dt->master_data_user;
					$itemnotif['notif_type'] 	= 'visitor';
					$itemnotif['notif_content'] 	= $messages;
					// $itemnotif['notif_date'] 	= date('Y-m-d H:i:s', strtotime('+7 hour'));
					$itemnotif['notif_date'] 		= date('Y-m-d H:i:s');
					$itemnotif['notif_status'] 	= 'unread';
					$itemnotif['notif_id_detail'] 	= $id;

					$this->api->add_custom($itemnotif,'notification_mobile');


					echo json_encode(array('status' => 'open'));
				}  
				else echo json_encode(array('status' => 'closed'));
			// }
		} 
	}    

	
	
	
	function ticket2($temp) { 
		if($temp!='check') return false;
 
		$token =  $_GET['ticket']; 

		if (strpos($token,  'mytelumobile') !== false) {

			$response = KTMDigitalMyTelU($token);
			
			$dt = json_decode($response,true);  

			if($dt['success']==true){

				$dt = $this->rm->GetRfid('',$dt['data']['username'])->row();  
				if ($dt){   
					$temp = array(
						"member_id" => $dt->id,
						"master_data_course" => $dt->master_data_course,
						"item_location_id" => '9',
						"attended_at" => date('Y-m-d H:i:s'),
						"created_at" => date('Y-m-d H:i:s'),
						"created_by" => "qrcode", 
						"updated_by" => "qrcode",
						"updated_at" => date('Y-m-d H:i:s')
					);  
					$this->rm->addAttendance($temp);
	

					$item_location = $this->api->item_location(9)->row();

					$messages 		= "Selamat Datang di Openlibrary ".$item_location->name;

					$itemnotif['notif_id_member'] 	= $dt->master_data_user;
					$itemnotif['notif_type'] 	= 'visitor';
					$itemnotif['notif_content'] 	= $messages;
					$itemnotif['notif_date'] 	= date('Y-m-d H:i:s', strtotime('+7 hour'));
					$itemnotif['notif_status'] 	= 'unread';
					$itemnotif['notif_id_detail'] 	= $id;

					$this->api->add_custom($itemnotif,'notification_mobile');


					echo json_encode(array('status' => 'open'));
				}  
				else echo json_encode(array('status' => 'closed'));
			}
			else echo json_encode(array('status' => 'closed'));
		}
		else {

			if(strlen($token)<=15){ 
				echo json_encode(array('status' => 'closed'));
			}
			else {    
				$this->load->helper('jwt'); 
		

				$jwt = new JWT();

				$payload = $jwt->decode($token, 'qrcode'); 
			
				$date = date('Y-m-d H:i:s');
				$timenow = strtotime($date);
				$timetoken = strtotime($payload->expired);
		
				// //pake qrcode
				if($timenow>$timetoken)  { 
					echo json_encode(array('status' => 'closed'));
				}
				else {
					// $status 			= "success";
					$dt = $this->rm->GetRfid('',$payload->username)->row();  
					if ($dt){   
						$temp = array(
							"member_id" => $dt->id,
							"master_data_course" => $dt->master_data_course,
							"item_location_id" => '9',
							"attended_at" => date('Y-m-d H:i:s'),
							"created_at" => date('Y-m-d H:i:s'),
							"created_by" => "qrcode", 
							"updated_by" => "qrcode",
							"updated_at" => date('Y-m-d H:i:s')
						);  
						$this->rm->addAttendance($temp);
		

						$item_location = $this->api->item_location(9)->row();

						$messages 		= "Selamat Datang di Openlibrary ".$item_location->name;

						$itemnotif['notif_id_member'] 	= $dt->master_data_user;
						$itemnotif['notif_type'] 	= 'visitor';
						$itemnotif['notif_content'] 	= $messages;
						$itemnotif['notif_date'] 	= date('Y-m-d H:i:s', strtotime('+7 hour'));
						$itemnotif['notif_status'] 	= 'unread';
						$itemnotif['notif_id_detail'] 	= $id;

						$this->api->add_custom($itemnotif,'notification_mobile');


						echo json_encode(array('status' => 'open'));
					}  
					else echo json_encode(array('status' => 'closed'));
				}
			} 
		}
	} 
	
}

?>